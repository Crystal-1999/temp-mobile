<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sign in to your Temp Number account to access temporary phone numbers, manage your activations, and view your transaction history.">
  <meta name="keywords" content="login, sign in, account access, user login, temp number login">
  <meta name="robots" content="noindex, nofollow">
  <link rel="canonical" href="https://temp-number.com/app/login">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://temp-number.com/app/login">
  <meta property="og:title" content="Login - Sign In to Your Account | Temp Number">
  <meta property="og:description" content="Sign in to your Temp Number account to access temporary phone numbers, manage your activations, and view your transaction history.">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Login - Sign In to Your Account | Temp Number">
  <meta name="twitter:description" content="Sign in to your Temp Number account to access temporary phone numbers, manage your activations, and view your transaction history.">
  
  <title>Login - Sign In to Your Account | Temp Number</title>
  <link rel="icon" href="/image/logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/app.css">
</head>

<body>
  <%- include('../../components/app_navbar') %>

    <div class="container py-4 py-md-5">
      <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5">
          <div class="login-container">
            <div class="heading text-center mb-4">Sign In</div>

            <form id="login-form" class="form" novalidate>
              <!-- Email Field -->
              <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <div class="input-wrapper">
                  <input required class="input form-control" type="email" name="email" id="email"
                    placeholder="Enter your email" autocomplete="email">
                </div>
                <div class="field-error" id="email-error"></div>
              </div>

              <!-- Password Field -->
              <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <div class="input-wrapper">
                  <input required class="input form-control" type="password" name="password" id="password"
                    placeholder="Enter your password" autocomplete="current-password">
                  <button type="button" class="btn btn-link password-toggle" id="togglePassword"
                    aria-label="Toggle password visibility">
                    <i class="fas fa-eye" id="passwordIcon"></i>
                  </button>
                </div>
                <div class="field-error" id="password-error"></div>
              </div>

              <!-- General Error Message -->
              <div id="error-message" class="alert-message alert-error d-none mb-3" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="error-text"></span>
              </div>

              <!-- Submit Button -->
              <button class="btn login-button w-100" type="submit" id="submitBtn">
                <span class="btn-text">Sign In</span>
                <span class="spinner-border spinner-border-sm d-none ms-2" id="submitSpinner" role="status"></span>
              </button>
            </form>

            <div class="signup-link text-center mt-4">
              <span class="text-muted">Don't have an account?</span>
              <a href="/app/signup" class="ms-1">Sign Up</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Password visibility toggle
      const togglePassword = document.getElementById('togglePassword');
      const passwordInput = document.getElementById('password');
      const passwordIcon = document.getElementById('passwordIcon');

      if (togglePassword && passwordInput) {
        togglePassword.addEventListener('click', function () {
          const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
          passwordInput.setAttribute('type', type);
          passwordIcon.classList.toggle('fa-eye');
          passwordIcon.classList.toggle('fa-eye-slash');
        });
      }

      // Form validation
      const form = document.getElementById("login-form");
      const submitBtn = document.getElementById("submitBtn");
      const btnText = submitBtn.querySelector('.btn-text');
      const submitSpinner = document.getElementById("submitSpinner");
      const errorMessage = document.getElementById("error-message");
      const errorText = document.getElementById("error-text");

      // Field error elements
      const emailError = document.getElementById('email-error');
      const passwordError = document.getElementById('password-error');
      const emailInput = document.getElementById('email');

      // Helper function to show field error
      function showFieldError(field, errorElement, message) {
        field.classList.add('has-error');
        errorElement.textContent = message;
        errorElement.classList.add('show');
      }

      // Helper function to clear field error
      function clearFieldError(field, errorElement) {
        field.classList.remove('has-error');
        errorElement.textContent = '';
        errorElement.classList.remove('show');
      }

      // Real-time validation - only after user interaction
      if (emailInput) {
        emailInput.addEventListener('blur', function () {
          if (!this.value) {
            showFieldError(this, emailError, 'Email is required');
          } else if (!this.validity.valid) {
            showFieldError(this, emailError, 'Please enter a valid email address');
          } else {
            clearFieldError(this, emailError);
          }
        });

        emailInput.addEventListener('input', function () {
          if (this.classList.contains('has-error') && this.validity.valid) {
            clearFieldError(this, emailError);
          }
        });
      }

      if (passwordInput) {
        passwordInput.addEventListener('blur', function () {
          if (!this.value) {
            showFieldError(this, passwordError, 'Password is required');
          } else {
            clearFieldError(this, passwordError);
          }
        });

        passwordInput.addEventListener('input', function () {
          if (this.classList.contains('has-error') && this.value) {
            clearFieldError(this, passwordError);
          }
        });
      }

      form.addEventListener("submit", async function (event) {
        event.preventDefault();

        // Hide previous error
        errorMessage.classList.add("d-none");

        // Clear all field errors
        clearFieldError(emailInput, emailError);
        clearFieldError(passwordInput, passwordError);

        // Validate email
        if (!emailInput.value) {
          showFieldError(emailInput, emailError, 'Email is required');
          emailInput.focus();
          return;
        } else if (!emailInput.validity.valid) {
          showFieldError(emailInput, emailError, 'Please enter a valid email address');
          emailInput.focus();
          return;
        }

        // Validate password
        if (!passwordInput.value) {
          showFieldError(passwordInput, passwordError, 'Password is required');
          passwordInput.focus();
          return;
        }

        // Show loading state
        submitBtn.disabled = true;
        btnText.textContent = 'Signing in...';
        submitSpinner.classList.remove("d-none");

        const data = {
          email: emailInput.value.trim(),
          password: passwordInput.value.trim()
        };

        try {
          const response = await fetch('/app/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (response.ok) {
            btnText.textContent = 'Success! Redirecting...';
            document.cookie = `token=${result.token}; path=/;`;
            localStorage.setItem('token', result.token);
            localStorage.setItem('customer', JSON.stringify(result.customer));
            setTimeout(() => {
              window.location.href = '/';
            }, 1000);
          } else {
            errorText.textContent = result.error || 'Login failed. Please try again.';
            errorMessage.classList.remove("d-none");

            submitBtn.disabled = false;
            btnText.textContent = 'Sign In';
            submitSpinner.classList.add("d-none");
          }
        } catch (err) {
          console.error('Fetch Error:', err);
          errorText.textContent = 'Network error. Please check your connection and try again.';
          errorMessage.classList.remove("d-none");

          submitBtn.disabled = false;
          btnText.textContent = 'Sign In';
          submitSpinner.classList.add("d-none");
        }
      });
    </script>

    <script src="/js/script.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
</body>

</html>